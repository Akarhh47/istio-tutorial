<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diferencia and Detecting Regressions :: Istio Workshop</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/istio-tutorial/workshop/istio-tutorial/1.4.x/advanced/diferencia.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://redhat-developer-demos.github.io/istio-tutorial/workshop">Istio Workshop</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container"  data-component="istio-tutorial"
  data-version="1.4.x" >
  <aside class="navigation">
    <div class="panels">
      <div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Istio Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../workshop/1setup.html">1. Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#redeployingcode">Updating Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#monitoring">Monitoring with Grafana</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#prometheus">Prometheus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#tracing">Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../3kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#updatekiali">Update Kiali</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../3kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4simple-routerules.html#deployrecommendationv2">Deploy Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">7. Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../8egress.html">Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../8acl.html">Access Control List</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#whitelist">White List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#blacklist">Black List</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../8mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#testingtls">Testing mTLS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../8jwt.html">End-user authentication with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#enablingauthentication">Enabling end-user authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../8rbac.html">Istio Role Based Access Control (RBAC)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#enabling-rbac">Enabling RBAC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#authorization-jwt">Authorization and JWT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#final-notes">Final Notes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#">8tips.adoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
  <div class="navigation-explore" data-panel="explore">
  <div class="context">
    <!-- Just a place holder to fill in  explorer for each context -->
  </div>
</div>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../index.html" class="home-link"></a>
  <nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">Istio Tutorial</a></li>
    <li class="crumb"><a href="diferencia.html">Diferencia and Detecting Regressions</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1>Diferencia and Detecting Regressions</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice nor destinationrule (in <code>tutorial</code> namespace) <code>kubectl get virtualservice</code> <code>kubectl get destinationrule</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-diferencia"><a class="anchor" href="#what-is-diferencia"></a>What is Diferencia?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is designed to act as a proxy which intercepts calls to a service and multicast it to several instances of the same service.
These instances are an old and new version of the service. Then when the response is returned from each instance, Diferencia will check if both responses are <em>similar</em>, and if it is the case, then the two implementations might be considered compatible and the new version implementation is <strong>regression-free</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-simple.png" alt="Overview of Diferencia">
</div>
</div>
<div class="paragraph">
<p>In the previous schema, you can see that a request is multicasted to two instances of Service A, one being V1 and to other V2.
Both return a response and then it is compared by Diferencia.
Finally, notice that no response is returned (<em>by default</em>) but the result (in form of HTTP Status Code).</p>
</div>
<div class="paragraph">
<p>Since Diferencia does not return a real response, but a comparison, effectively means that it is a perfect fit for <strong>Traffic Shadowing/Mirroring</strong> technique.</p>
</div>
<div class="sect2">
<h3 id="master-candidate"><a class="anchor" href="#master-candidate"></a>Selecting Master and Candidate</h3>
<div class="paragraph">
<p>The first thing you need to do is selecting a <strong>master</strong> service (the one you know it works) and a <strong>candidate</strong> service (the one you want to release) and create a Kubernetes service.
For this case, <strong>master</strong> is <code>recommendation:v1</code> and <strong>candidate</strong> is <code>recommendation:v2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
oc create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial

or

kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-master-svc.yml">diferencia/recommendation-master-svc.yml</a> -n tutorial
kubectl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/recommendation-candidate-svc.yml">diferencia/recommendation-candidate-svc.yml</a> -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-diferencia"><a class="anchor" href="#deploying-diferencia"></a>Deploying Diferencia</h3>
<div class="paragraph">
<p>Next thing is to deploy Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment.yml">diferencia/Deployment.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shadowing-traffic"><a class="anchor" href="#shadowing-traffic"></a>Shadowing Traffic</h3>
<div class="paragraph">
<p>The last thing is to just start shadowing traffic between <code>recommendation:v1</code> and diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v1-v2.yml">istiofiles/destination-rule-recommendation-v1-v2.yml</a> -n tutorial

istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 8

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 2.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia.</p>
</div>
<div class="paragraph">
<p>Then how do you check if there is any regression or not?
Diferencia offers different ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">logs</dt>
<dd>
<p>If you start Diferencia in <code>debug</code> mode (in this example it is) then you can inspect the results of each request.</p>
</dd>
<dt class="hdlist1">API</dt>
<dd>
<p>There is an endpoint that returns a JSON document with the stats of each request/response. <code>:8082/stats</code>.</p>
</dd>
<dt class="hdlist1">Dashboard</dt>
<dd>
<p>There is a simple HTML dashboard to get the stats. <code>:8082/dashboard</code>.</p>
</dd>
<dt class="hdlist1">Prometheus</dt>
<dd>
<p>All statistics are exposed in Prometheus format. <code>:8081/metrics</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Check the logs of Diferencia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">time="2018-11-14T12:07:43Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:43Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"
time="2018-11-14T12:07:50Z" level=debug msg="URL / is going to be processed"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-14T12:07:50Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is false"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And notice that in both cases the response is <code>false</code>.
This means that recommendation v1 and recommendation v2 are not compatible.
The reason of that is because of both responses are not equal (<code>recommendation v1 from '5f97c568c4-rkb8t': 8</code>, <code>recommendation v2 from '5f97cab34c4-r348t': 12</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This example uses a text comparison which is fine for this case but not in a real use case. Diferencia is built to work perfectly fine in different scenarios where JSON is the content type. You can read more about how Diferencia works when content is JSON <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.0/run-diferencia.html#modes">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="noise-detection"><a class="anchor" href="#noise-detection"></a>Noise Detection</h3>
<div class="paragraph">
<p>Notice that in the previous example we could agree that if <code>recommendation</code> was present, we could say that both services are compatible and they are regression-free.</p>
</div>
<div class="paragraph">
<p>To not make a simple comparision but something a bit more error-prone, Diferencia implements a <a href="https://lordofthejars.github.io/diferencia-docs-site/diferencia/0.4.1/run-diferencia.html#noise">Noise cancellation</a> approach to remove these parts that are dynamic (for example the hostname).</p>
</div>
<div class="paragraph">
<p>And it works like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/diferencia-noise.png" alt="Noise Cancellation">
</div>
</div>
<div class="paragraph">
<p>This algorithm sends the request to not two instances but three. Two are the old instances (primary and secondary) and one to the new instance (candidate).</p>
</div>
<div class="paragraph">
<p>The request to primary and secondary returns a valid request (since old instances are the correct ones), then from their responses, Diferencia checks for the differences between both responses.</p>
</div>
<div class="paragraph">
<p>Since both responses are valid (because the source is the same but different instances), the differences that are between them are just noise that should not take into consideration for response validation.</p>
</div>
<div class="paragraph">
<p>Then detected noise is removed from primary and candidate response, and they are compared, if they are equal, then you know that everything is fine.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Of course this is a simple example but in case of the JSON is where noise cancellation is really useful, for example for skipping fields such as time, random numbers, &#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_removes_old_diferencia_instance"><a class="anchor" href="#_removes_old_diferencia_instance"></a>Removes Old Diferencia instance</h4>
<div class="paragraph">
<p>Let&#8217;s remove Diferencia and mirroring.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_diferencia_with_noise_cancellation"><a class="anchor" href="#_deploy_diferencia_with_noise_cancellation"></a>Deploy Diferencia with Noise Cancellation</h4>
<div class="paragraph">
<p>Then let&#8217;s add Diferencia with noise cancellation enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
oc create -f diferencia/Service.yml -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/Deployment-noise-detection.yml">diferencia/Deployment-noise-detection.yml</a>) -n tutorial
kubectl create -f diferencia/Service.yml -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s enable mirroring again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml">diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can send two requests to the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 11

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '5f97c568c4-rkb8t': 14</code></pre>
</div>
</div>
<div class="paragraph">
<p>Things to notice here is that for each <code>curl</code> request, the counter is incremented by 3.
Why? Because one request is the one sent to the user and the other one is the one consumed by diferencia as <em>primary</em> and <em>seconday</em>.</p>
</div>
<div class="paragraph">
<p>Now if you check the logs of Diferencia, you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc logs -f `oc get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

or

kubectl logs -f `kubectl get pods|grep recommendation-diferencia|awk '{ print $1 }'` -c recommendation-diferencia

time="2018-11-16T08:57:33Z" level=debug msg="URL / is going to be processed"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-candidate:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Forwarding call to http://recommendation-master:8080/"
time="2018-11-16T08:57:33Z" level=debug msg="Result of comparing http://recommendation-master:8080/ and http://recommendation-candidate:8080/ is true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that now the result is <code>true</code> meaning that both services are equivalent.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is a simple example using text plain, but <a href="https://lordofthejars.github.io/diferencia-docs-site"><strong>Diferencia</strong></a> is really useful when the output is a JSON format where there can be incompatibilities.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Clean Up</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete deployments recommendation-diferencia
or
kubectl delete deployments recommendation-diferencia

oc delete service recommendation-candidate
or
kubectl delete service recommendation-candidate


oc delete service recommendation-master
or
kubectl delete service recommendation-master

istioctl delete -f diferencia/virtual-service-recommendation-v1-diferencia-mirror-v2.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer role="contentinfo">
  <div class="region region-rhd-footer">
    <div id="block-rhdfooter" class="rhd-footer">
      <nav class="rhd-footer-nav" aria-label="Secondary Navigation" role="navigation">
  <ul class="rhd-menu">
    <li class="menu-item menu-item--expanded">
      <h3 class="section-toggle">Resources</h3>
      <ul class="rhd-menu">
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/istio-tutorial" title="Istio Tutorial">Istio
            Tutorial</a>
        </li>
        <li class="menu-item">
          <a href="https://github.com/redhat-developer-demos/istio-tutorial/issues" title="Issue Tracker">Issue
            Tracker</a>
        </li>
      </ul>
    </li>
  </ul>
</nav>      <div class="rhd-footer-sidebar">
        <p class="rhd-footer-sidebar-title">Red Hat Developer</p>
        <p class="rhd-footer-sidebar-subtitle">Build here. Go anywhere.</p>
        <p class="rhd-footer-sidebar-content">
          We serve the builders. The problem solvers who create careers with
          code.<br /><br /><a href="https://developer.redhat.com/register">Join us</a>
          if you’re a developer, software engineer, web designer, front-end
          designer, UX designer, computer scientist, architect, tester,
          product manager, project manager or team lead.
        </p>
        <ul class="rhd-footer-sidebar-social">
          <li>
            <a href="https://www.youtube.com/channel/UC7noUdfWp-ukXUlAsJnSm-Q" target="_blank"
              rel="noopener noreferrer"><svg class="svg-inline--fa fa-youtube fa-w-18" aria-hidden="true"
                data-prefix="fab" data-icon="youtube" role="img" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 576 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z">
                </path>
              </svg><!-- <i class="fab fa-youtube"></i> --></a>
          </li>
          <li>
            <a href="https://www.facebook.com/RedHatDeveloperProgram" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-facebook fa-w-14" aria-hidden="true" data-prefix="fab" data-icon="facebook"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M448 56.7v398.5c0 13.7-11.1 24.7-24.7 24.7H309.1V306.5h58.2l8.7-67.6h-67v-43.2c0-19.6 5.4-32.9 33.5-32.9h35.8v-60.5c-6.2-.8-27.4-2.7-52.2-2.7-51.6 0-87 31.5-87 89.4v49.9h-58.4v67.6h58.4V480H24.7C11.1 480 0 468.9 0 455.3V56.7C0 43.1 11.1 32 24.7 32h398.5c13.7 0 24.8 11.1 24.8 24.7z">
                </path>
              </svg><!-- <i class="fab fa-facebook"> </i> --></a>
          </li>
          <li>
            <a href="https://twitter.com/rhdevelopers" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-twitter fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="twitter"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z">
                </path>
              </svg><!-- <i class="fab fa-twitter"> </i> --></a>
          </li>
          <li>
            <a href="https://github.com/redhat-developer" target="_blank" rel="noopener noreferrer"><svg
                class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" data-prefix="fab" data-icon="github"
                role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg="">
                <path fill="currentColor"
                  d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z">
                </path>
              </svg><!-- <i class="fab fa-github"> </i> --></a>
          </li>
        </ul>
        <a class="rhd-footer-sidebar-signup" href="https://developers.redhat.com/register">Sign me up ▸</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>
